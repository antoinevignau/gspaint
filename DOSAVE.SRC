;======================================================;;                                                      ;;              D O S A V E                             ;;                                                      ;;======================================================;DoSave         Start               Using  AllEqu               Using  Data               Using  CursPat               Using  CurSor               Using  Strings               Longa On               Longi On               Jsr  SupSelection               Jsr  CloseText               Jsr  ScreenToStock               Jsr  TestLLDBack         Sort DirectementDoSave2        Entry               Lda  TopFile             Teste si fichier ouvert               Jne  MakeSave               Bra  SaveSousDoSaveAs       Entry               Jsr  SupSelection               Jsr  CloseText               Jsr  ScreenToStock               Jsr  TestLLDBack         Sort directementSaveSous       Anop               Pha             Recupere le titre de la fenetre               Pha               PushLong PaintPort               _GetWTitle               PushPtr TitleWin               Pea  0               Pea  16               _BlockMove               Lda  #1                    Initialisation des boutons               Sta  Radio1Init               Stz  Choix                 Stz  Radio2Init               Lda  CurFileType               Cmp  #PaintType               Beq  OkInitRadio               Lda  #1               Sta  Radio2Init               Sta  Choix               Stz  Radio1Init OkInitRadio    Anop               Pea  25                  X               Pea  30                  Y               PushPtr SaveAs               PushPtr TitleWin               Pea  15               PushPtr PatchedPutDialog               PushPtr DilgHookPut               PushPtr Reponse               _SfPPutFile               Jsr  ForceUpdate               _ShowCursor               Lda  Good               Bne  MakeSave               Clc               RtsMakeSave       Anop               Lda  #PaintType                 Suppose Paint Type               Sta  CurFileType               Lda  Choix               Beq  OkPaintType                         Lda  #PaintBin               Sta  CurFileTypeOkPaintType    Anop               PushLong #0              Laisse dans la Pile               _GetCursorAdr               PullLong CurCursor               PushPtr Watch               _SetCursor               Lda  CurFileType               Sta  CreateFileType               Cmp  #PaintType          Format Paint               Beq  SvPaint               Brl  SavePaint1SvPaint        Anop               Brl  SavePaintSaveSuite      Anop               PushLong CurCursor               _SetCursor               PushPtr  TitleWin               PushLong PaintPort               _SetWTitle               Sec                      Save Ok               Rts;------------------------------------------------------;;      SavePaint1   Format Ecran;SavePaint1     Anop               _Create CreateParms               Bcc  E10               Cmp  #$47                File Already exist               Jne  CloseSave               _GetFileInfo GetInfoParms               Lda  #PaintBin           Binaire mais Venant de Paint               Sta  SetInfoType               _SetFileInfo SetInfoParmsE10            Anop               Stz  OpenBuf               Stz  OpenBuf+2               _Open OpenParms               Bcc  *+5               Brl  CloseSave               PushPtr Watch               _SetCursor               lda  OpenParms           Ref Nums               Sta  WriteParms               Sta  GetMarkParms               Sta  SetEofParms               Lda  PtrStock               Sta  WriteBuffer               Lda  PtrStock+2               Sta  WriteBuffer+2               Lda  #200*160               Sta  RequestWrt               _Write WriteParms               Jcs  CloseSave;----- Scan Lines et Palettes -----               Pea  0               _SetAllScbs               Lda  #$300               Sta  RequestWrt               Stz  RequestWrt+2               Lda  #<$E19D00               Sta  WriteBuffer               Lda  #^$E19D00               Sta  WriteBuffer+2               _Write WriteParms               Jcs  CloseSave               _InitPalette               _GetMark GetMarkParms               Jcs  CloseSave               _SetEof SetEofParms               Jcs  CloseSave               _Close CloseParms               Lda  #True               Sta  TopFile               Stz  TopModif               Brl  SaveSuite;------------------------------------------------------;;      SavePaint;SavePaint      Anop               _Create CreateParms               Bcc  EE10               Cmp  #$47                File Already exist               Jne  CloseSave               _GetFileInfo GetInfoParms               Jcs  CloseSave               Lda  #PaintType          Type Paint               Sta  SetInfoType               _SetFileInfo SetInfoParms               Jcs  CloseSaveEE10           Anop               Stz  OpenBuf               Stz  OpenBuf+2               _Open OpenParms               Jcs  CloseSave               PushPtr Watch               _SetCursor               lda  OpenParms           Ref Nums               Sta  WriteParms               Sta  GetMarkParms               Sta  SetEofParms;----- Save de la Palette -----               Pea  0               PushLong pBuffer               _GetColorTable               Lda  CurBkPat               Dea               Eor  #$F               Ldy  #$20               Sta  [pBuffer],y               MoveLong pBuffer,WriteBuffer               Lda  #$22               Sta  RequestWrt               _Write WriteParms               Jcs  CloseSave;----- Pattern ----------               Lda  #<PatternBuffer               Sta  WriteBuffer               Lda  #^PatternBuffer               Sta  WriteBuffer+2               Lda  #16*32               Sta  RequestWrt               _Write WriteParms               Jcs  CloseSave;----- Image -----               MoveLong pBuffer,WriteBuffer               MoveLong PtrStock,Pointer               Ldy  #PageyLoopWrite      Anop               Phy               Lda  #Pagex/2               Sta  PicSize               MoveLong Pointer,PicPtrLoopWrite2     Anop               Pha               PushPtr PicPtr                                PushPtr PicSize               PushLong pBuffer               Pea  Pagex/2               _PackBytes               Pla               Sta  RequestWrt               _Write WriteParms               Jcs  CloseSave               Lda  PicSize               Bne  LoopWrite2               Clc               Lda  Pointer               Adc  #Pagex/2               Sta  Pointer               Ply               Dey               Bne  LoopWriteEndWrt         Anop               _GetMark GetMarkParms               Jcs  CloseSave               _SetEof SetEofParms               Jcs  CloseSave               _Close CloseParms               Lda  #True               Sta  TopFile               Stz  TopModif               Brl  SaveSuite;------------------------------------------------------;;              DilgHookPut;DilgHookPut    AnopDirect         Equ  1Data_Bank      Equ  3Rtl1           Equ  4MyItem         Equ  Rtl1+3TheDialog      Equ  MyItem+4               Phb               Phd               Phk               Plb               Lda  MyZPage               Tcd               lda  TheDialog,s               sta  Ptr10               lda  TheDialog+2,s               sta  Ptr10+2               lda  MyItem,s               sta  Ptr14               lda  MyItem+2,s               sta  Ptr14+2               lda  [Ptr14]               Sta  ItemHit               cmp  #13               Blt  Exit               ldx  #14               lda  ItemHit               cmp  #13               beq  NoFirst               dexNoFirst        anop               Stx  AutreItem               Pha               PushLong Ptr10               PushWord ItemHit               _GetItemValue               pla               bne  NoChange               sec               lda  ItemHit               sbc  #13               sta  Choix               Pea  1               PushLong Ptr10               PushWord ItemHit               _SetItemValueNoChange       anop               lda     #0               sta     [Ptr14]Exit           Anop               Pld               Plb               Lda  0,s               Sta  8,s               Lda  2,s               Sta  10,s               Pla               Pla               Pla               Pla               RtlPatchedPutDialog Anop               dc   i'0,0,140,270'               dc   i'-1'               dc   i4'0'               dc   i4'SaveButP'               dc   i4'OpenButP'               dc   i4'CloseButP'               dc   i4'NextButP'               dc   i4'CancelButP'               dc   i4'ScrollP'                              dc   i4'PathP'               dc   i4'FilesP'               dc   i4'PromptP'               dc   i4'EditP'               dc   i4'StatTextP'               dc   i4'CreateButP'               dc   i4'Radio1'               dc   i4'Radio2'               dc   i4'0'SaveButP       dc   i'1'               dc   i'93,165,105,265'               dc   i'ButtonItem'               dc   i4'SaveStr'               dc   i'0'               dc   i'0'               dc   i4'0'OpenButP       dc   i'2'               dc   i'54,165,66,265'               dc   i'ButtonItem'               dc   i4'OpenStr'               dc   i'0'               dc   i'0'               dc   i4'0'CloseButP      dc   i'3'               dc   i'72,165,84,265'               dc   i'ButtonItem'               dc   i4'CloseStr'               dc   i'0'               dc   i'0'               dc   i4'0'NextButP       dc   i'4'               dc   i'15,165,27,265'               dc   i'ButtonItem'               dc   i4'DriveStr'               dc   i'0'               dc   i'0'               dc   i4'0'CancelButP     dc   i'5'               dc   i'111,165,123,265'               dc   i'ButtonItem'               dc   i4'CancelStr'               dc   i'0'               dc   i'0'               dc   i4'0'ScrollP        dc   i'6'               dc   i'26,144,88,157'               dc   i'ScrollBarItem'               dc   i4'0'               dc   i'0'               dc   i'3'               dc   i4'0'PathP          dc   i'7'               dc   i'00,10,12,170'               dc   i'UserItem'               dc   i4'0'               dc   i'0'               dc   i'0'               dc   i4'0'          FilesP         dc   i'8'               dc   i'26,10,88,145'               dc   i'UserItem'               dc   i4'0'               dc   i'0'               dc   i'0'               dc   i4'0'PromptP        dc   i'9'               dc   i'88,10,100,170'               dc   i'UserItem+$8000'               dc   i4'0'               dc   i'0'               dc   i'0'               dc   i4'0'EditP          dc   i'10'               dc   i'100,10,118,157'               dc   i'EditLine'               dc   i4'TitleWin'               dc   i'15'               dc   i'0'               dc   i4'0'StatTextP      dc   i'11'               dc   i'12,10,22,160'               dc   i'StatText+$8000'               dc   i4'KbFreeStr'               dc   i'0'               dc   i'0'               dc   i4'0'CreateButP     dc   i'12'               dc   i'33,165,45,265'               dc   i'ButtonItem'               dc   i4'FolderStr'               dc   i'0'               dc   i'0'               dc   i4'0'Radio1         dc   i'13'               dc   i'127,10,137,110'               dc   i'RadioItem'               dc   i4'PaintFStr'Radio1Init     dc   i'0'               dc   i'0'               dc   i4'0'Radio2         dc   i'14'               dc   i'127,130,137,265'               dc   i'RadioItem'               dc   i4'ScreenFStr'Radio2Init     dc   i'0'               dc   i'0'               dc   i4'0';------------------------------------------------------;;              Close Suite Error;CloseSave      Anop               Pha               _Close  CloseParms                                  Pla               Ldx  #0               Jsl  DoError               PushLong CurCursor               _SetCursor               Clc               Rts;------------------------------------------------------;;              Test LLD Background;TestLLDBack    Anop               Pea  0               _LLDCheckBack               Pla               Beq  NoLLDBack               MoveRect NoSaveRect,Item2Rect               Pha               PushPtr TheTemplate               PushLong #0               _Alert               Pla               Jsr   ForceUpdate               Pla                      Pour Sortir directementNoLLDBack      Anop               Rts  TheTemplate    Anop               Dc   i'40,60,100,300'               dc   i'1'               dc   i1'$80,$80,$80,$80'          Stage of Alert               dc   i4'Item1'               dc   i4'Item2'               dc   i4'0'Item1          Anop               dc   i'1'               dc   i'36,90,50,160'                dc   i'ButtonItem'               dc   i4'OkStr'               dc   i'0'               dc   i'0'               dc   i4'0'Item2          Anop               dc   i'2'Item2Rect      dc   i'17,10,31,250'               dc   i'StatText'               dc   i4'NoSaveStr'               dc   i'0'               dc   i'0'               dc   i4'0'                  ;------------------------------------------------------;;              Data;PicPtr         Ds   4PicSize        Ds   2CurCursor      Ds   4MyDialog       ds   4Choix          ds   2Pointer        ds   4ItemHit        ds   2AutreItem      ds   2;------------------------------------------------------;;      Parametres pour ProDos;CreateParms    Anop               dc   i4'FileName'               dc   i'$C3'CreateFileType dc   i'PaintType'               dc   I'0'               dc   i'0'               dc   i'0'               dc   i'0'OpenParms      Anop               dc   i'0'                Ref Nums               dc   I4'Filename'OpenBuf        dc   I4'0'WriteParms     Anop               dc   i'0'                RefNumsWriteBuffer    dc   I4'0'RequestWrt     dc   I4'200*160'               dc   I4'0'CloseParms     dc   i'0'SetEofParms    AnopSetMarkParms   AnopGetMarkParms   Anop               dc   i'0'                RefNumsEof            AnopMark           dc   I4'0'GetInfoParms   AnopSetInfoParms   Anop               dc   i4'FileName'               ds   2SetInfoType    AnopGetInfoType    ds   2               ds   4               ds   2               ds   2               ds   2               ds   2               ds   2BlockUsed      ds   4               End