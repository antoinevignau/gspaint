;======================================================;;                                                      ;;              S E A R C H C O L O R                   ;;                                                      ;;======================================================;SearchColor    Start               Using AllEqu               Using Data               Using CursPat               Using Cursor               Jsr  SupSelection               Jsr  CloseText               Jsr  ScreenToStock               Pha               Pha               _GetCursorAdr               Pla               Sta  CurCursor               Pla               Sta  CurCursor+2               Pea  0               PushPtr TableCol               _GetColorTable               PushPtr SearchCroix               _SetCursor;----- Initialisation -----               Stz  TheColor               Stz  TheColor2               Stz  LastColor               Stz  LastColor2               Stz  LastWhen               Stz  WhatCligne;----- Boucle Principale -----MainLoop       Anop               Pea  0               Pea  $FFFF               PushPtr EventRecord               _GetNextEvent               Pla;----- Gestion du clignotement -----               Sec               Lda  EvtWhen               Sbc  LastWhen               Cmp  #$A               Blt  NoCligne               Lda  EvtWhen               Sta  LastWhen               Lda  TheColor2               Beq  NoCligne               Lda  WhatCligne               Eor  #$FFFF               Sta  WhatCligne               Bmi  Inverse               Ldx  TheColor2               Lda  SaveColor               Jsr  PutColor               Bra  NoCligneInverse        Anop               Ldx  TheColor2               Lda  #$FFFF               Jsr  PutColorNoCligne       Anop               Lda  EvtWhat               Cmp  #MouseDown               Jeq  ExitSearchFindColor      Anop               Pha                      Recupere le Curseur               Pha               _GetCurSorAdr               Pla               Sta  WhatCursor               Pla               Sta  WhatCursor+2               Pha               PushPtr EvtWhere               PushPtr Paint_Rect       En Globale               _PtInrect               Pla               Jne  InPaint               Pha               PushPtr EvtWhere               PushPtr ColorRect        En Globale               _PtInrect               Pla               Bne  InColor               Lda  WhatCursor               Cmp  FlechePtr               Bne  SetFleche               Lda  WhatCursor+2               Cmp  FlechePtr+2               Beq  NotSetFlecheSetFleche      Anop               PushLong FlechePtr               _SetCursor               Jsr  CloseCligne               Stz  TheColor               Stz  TheColor2               Stz  WhatCligne               Jsr  SelectColor               Jsr  InvertColorNotSetFleche   Anop               Brl  MainLoop;----- In Color -----InColor        Anop               Lda  WhatCursor               Cmp  #<SearchCroix               Bne  SetCroix2               Lda  WhatCursor+2               Cmp  #^SearchCroix               Beq  NotSetCroix2SetCroix2      Anop               Stz  LastColor2               Stz  LastColor               Stz  WhatCligne               PushPtr SearchCroix               _SetCursorNotSetCroix2   Anop               PushLong PatPort               _SetPort               PushPtr EvtWhere               _GlobalToLocal               PushLong PaintPort               _SetPort               Jsr  WitchRecPat               Bcc  NoSelectPat               Cpx  #16               Bge  NoSelectPat               Cpx  #1               Beq  NoSelectPat               Stx  TheColor2               Jsr  InvertColorNoSelectPat    Anop               Brl  MainLoop;----- In Paint -----InPaint        Anop               Lda  WhatCursor               Cmp  #<SearchCroix               Bne  SetCroix               Lda  WhatCursor+2               Cmp  #^SearchCroix               Beq  NotSetCroixSetCroix       Anop               Jsr  CloseCligne               Stz  LastColor               Stz  LastColor2               Stz  WhatCligne               PushPtr SearchCroix               _SetCursorNotSetCroix    Anop               PushPtr EvtWhere               _GlobalToLocal               Jsr  MapEvtWhere               Jsr  GetThePixel               Jsr  SelectColor               Brl  MainLoop;------------------------------------------------------;;              CloseCligne;CloseCligne    Anop               Lda  TheColor2               Beq  RtsCC               Ldx  LastColor2               Lda  SaveColor               Jsr  PutColorRtsCC          Anop               Rts;------------------------------------------------------;;              GetThePixel;GetThePixel    Anop               Lda  Evty               Jsr  Mul160               Clc               Adc  PtrStock               Sta  Ptr10               Lda  PtrStock+2               Sta  Ptr10+2               Lda  Evtx               Lsr  A               Tay               Lda  [Ptr10],y               Xba               Pha               Lda  Evtx               Lsr  A                   Positionne la Carry               Pla               Bcs  Impair               Lsr  A               Lsr  A               Lsr  A               Lsr  AImpair         Anop               And  #$0F00               Xba               Eor  #$000F               Ina               Sta  TheColor               Rts;------------------------------------------------------;;              InvertColor;InvertColor    Anop               Lda  LastColor2               Beq  Change3               Cmp  TheColor2               Bne  Change2               RtsChange2        Anop               Tax               Lda  SaveColor               Jsr  PutColorChange3        Anop               Lda  TheColor2               Bne  OkSet               RtsOkSet          Anop               Sta  LastColor2               Dea               Eor  #$000F               Asl  A               Tax               Lda  TableCol,x               Sta  SaveColor               Lda  #$FFFF               Ldx  LastColor2               Jsr  PutColor               Rts;------------------------------------------------------;;              PutColor;PutColor       Anop               Pha               Txa               Dea               Eor  #$000F               Asl  A               Tax               Pla               Sta  TableCol,x               Pea  0               PushPtr TableCol               _SetColorTable               Rts;------------------------------------------------------;;              SelectColor;SelectColor    Anop               Lda  LastColor               Beq  Change               Cmp  TheColor               Bne  Change               RtsChange         Anop               PushLong PatPort               _SetPort               Ldx  LastColor               Beq  NoEfface               Jsr  CalAdPat               Phx               Pha               _SetPenPat               PushPtr TheRect          Efface l'ancien               _FrameRectNoEfface       Anop               Ldx  TheColor               Stx  LastColor               Beq  NoFrame               PushPtr TheRect               Jsr  CalRectPat               PushPtr TheRect               Lda  #1               Pha               Pha               _InsetRect               Lda  TheColor               Jsr  CalSomme               Cmp  #22               Blt  PutBlanc               PushPtr Black               Bra  SetPatPutBlanc       Anop               PushPtr WhiteSetPat         Anop               _SetPenPat               PushPtr TheRect               _FrameRectNoFrame        Anop               PushLong PaintPort                      _SetPort               Rts;------------------------------------------------------;;              CalSomme;; Si la Somme R+G+B < 21 la Frame est Noir,Blanche AutrementCalSomme       Anop               Stz  Somme               Dea               Eor  #$000F               Asl  A               Tax               Lda  TableCol,x               Pha               And  #$F000               Xba               Lsr  A               Lsr  A               Lsr  A               Lsr  A               Clc               Adc  Somme               Sta  Somme               Lda  1,s               And  #$0F00               Xba               Clc               Adc  Somme               Sta  Somme               Lda  1,s               And  #$00F0               Lsr  A               Lsr  A               Lsr  A               Lsr  A               Clc               Adc  Somme               Sta  Somme               Pla               And  #$000F               Clc               Adc  Somme               Rts;------------------------------------------------------;;              ExitSearch;ExitSearch     Anop               PushLong PatPort               _SetPort               Ldx  LastColor               Beq  SetBlack               Jsr  CalAdPat               Phx               Pha               _SetPenPat               PushPtr TheRect          Efface le Rectangle               _FrameRectSetBlack       Anop               PushPtr Black               _SetPenPat               PushLong PaintPort               _SetPort               Jsr  CloseCligneReMetPas       Anop               PushLong CurCursor               _SetCursor               Pha               PushPtr EvtWhere               PushPtr Paint_Rect       En Globale               _PtInrect               Pla               Bne  ExitFin               Pha               Pea  MouseDown               PushLong EvtMsg               _PostEvent               PlaExitFin        Anop               Rts;------------------------------------------------------;;              Data;TheRect        ds   8TheColor       ds   2LastColor      ds   2TheColor2      ds   2LastColor2     ds   2Somme          ds   2CurCursor      Ds   4WhatCursor     ds   4TableCol       ds   32ColorRect      dc   i'165,PaintPosx+43,179,PaintPosx+257'SaveColor      ds   2LastWhen       ds   2WhatCligne     ds   2               End